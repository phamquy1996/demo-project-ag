<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test FCM v·ªõi DevTools</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
      font-size: 14px;
    }
    button:hover { background: #3367d6; }
    #output {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      margin: 10px 0;
      border-left: 4px solid #4285f4;
      max-height: 300px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .token-display {
      font-family: monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      word-break: break-all;
      margin: 10px 0;
    }
    .instructions {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      border-left: 4px solid #ffc107;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîß Test FCM v·ªõi DevTools Push Messaging</h2>
    
    <div class="instructions">
      <h3>üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h3>
      <ol>
        <li>Click "Kh·ªüi t·∫°o FCM" ƒë·ªÉ l·∫•y token v√† ƒëƒÉng k√Ω service worker</li>
        <li>M·ªü DevTools (F12) ‚Üí Tab Application ‚Üí Service workers</li>
        <li>T√¨m section "Push messaging" b√™n d∆∞·ªõi</li>
        <li>Nh·∫≠p message JSON v√†o √¥ text v√† click "Push"</li>
        <li>Click v√†o notification ƒë·ªÉ test chuy·ªÉn h∆∞·ªõng</li>
      </ol>
    </div>
    
    <div id="status"></div>
    
    <button onclick="initializeFCM()">üöÄ Kh·ªüi t·∫°o FCM</button>
    <button onclick="clearAllServiceWorkers()">üßπ Clear Service Workers</button>
    <button onclick="checkServiceWorkerStatus()">üîç Check SW Status</button>
    <button onclick="clearLogs()">üìù Clear Logs</button>
    
    <div id="token-section" style="display: none;">
      <h3>üì± FCM Token:</h3>
      <div id="token-display" class="token-display"></div>
      <button onclick="copyToken()">üìã Copy Token</button>
    </div>

    <div id="message-examples" style="display: none;">
      <h3>üìù Message Examples cho DevTools:</h3>
      
      <h4>1. Basic notification:</h4>
      <textarea readonly onclick="this.select()" style="width: 100%; height: 120px; font-family: monospace; font-size: 12px;">
{
  "notification": {
    "title": "Test t·ª´ DevTools",
    "body": "Click ƒë·ªÉ m·ªü Google!",
    "click_action": "https://google.com"
  }
}
      </textarea>
      
      <h4>2. Notification v·ªõi data:</h4>
      <textarea readonly onclick="this.select()" style="width: 100%; height: 140px; font-family: monospace; font-size: 12px;">
{
  "notification": {
    "title": "Test v·ªõi Data",
    "body": "Notification c√≥ custom data"
  },
  "data": {
    "click_action": "https://youtube.com",
    "custom_key": "custom_value"
  }
}
      </textarea>
      
      <h4>3. Ch·ªâ c√≥ data (silent notification):</h4>
      <textarea readonly onclick="this.select()" style="width: 100%; height: 100px; font-family: monospace; font-size: 12px;">
{
  "data": {
    "title": "Silent Push",
    "body": "Background notification",
    "click_action": "https://github.com"
  }
}
      </textarea>
    </div>

    <div id="output"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDHgZwBkp2syivHbLWM6Tgu3UoDBAQB8r0",
      authDomain: "smartonetestnoti.firebaseapp.com",
      projectId: "smartonetestnoti",
      storageBucket: "smartonetestnoti.appspot.com",
      messagingSenderId: "419243653443",
      appId: "1:419243653443:web:26348d8c428f2688c8d7f6"
    };

    const VAPID_KEY = "BCyq847B47TWps5HpECr2g9ebsQau3oLmKmyLAm3liG_bvhbSnM57-sksHfvYasph1np0p_SnuIItuu_Gnm4O0A";

    let messaging;
    let currentToken = '';

    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function log(message) {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      output.textContent += `[${timestamp}] ${message}\n`;
      output.scrollTop = output.scrollHeight;
      console.log(message);
    }

    function clearLogs() {
      document.getElementById('output').textContent = '';
    }

    async function clearAllServiceWorkers() {
      try {
        log('üßπ Clearing all service workers...');
        const registrations = await navigator.serviceWorker.getRegistrations();
        
        for (let registration of registrations) {
          await registration.unregister();
          log('‚úÖ Unregistered: ' + registration.scope);
        }
        
        // Clear caches
        const cacheNames = await caches.keys();
        for (let cacheName of cacheNames) {
          await caches.delete(cacheName);
          log('‚úÖ Deleted cache: ' + cacheName);
        }
        
        updateStatus('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ service workers v√† caches. Reload page ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i.', 'success');
        
        // Auto reload after 2 seconds
        setTimeout(() => {
          window.location.reload();
        }, 2000);
        
      } catch (error) {
        log('‚ùå Error clearing service workers: ' + error.message);
      }
    }

    async function checkServiceWorkerStatus() {
      try {
        log('üîç Checking service worker status...');
        
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`Found ${registrations.length} service worker(s)`);
        
        registrations.forEach((reg, index) => {
          log(`SW ${index + 1}: ${reg.scope}`);
          log(`  - Active: ${reg.active ? reg.active.scriptURL : 'None'}`);
          log(`  - Installing: ${reg.installing ? reg.installing.scriptURL : 'None'}`);
          log(`  - Waiting: ${reg.waiting ? reg.waiting.scriptURL : 'None'}`);
        });
        
        log(`Controller: ${navigator.serviceWorker.controller ? navigator.serviceWorker.controller.scriptURL : 'None'}`);
        log(`Ready state: ${await navigator.serviceWorker.ready ? 'Ready' : 'Not ready'}`);
        
      } catch (error) {
        log('‚ùå Error checking status: ' + error.message);
      }
    }

    async function initializeFCM() {
      try {
        updateStatus('üîÑ ƒêang kh·ªüi t·∫°o Firebase...', 'info');
        log('B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o FCM...');

        // Ki·ªÉm tra support
        if (!('serviceWorker' in navigator)) {
          throw new Error('Service Worker kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        }

        if (!('Notification' in window)) {
          throw new Error('Notification kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£');
        }

        // B∆Ø·ªöC 1: X√≥a t·∫•t c·∫£ service workers c≈©
        log('üßπ Cleaning up old service workers...');
        const existingRegistrations = await navigator.serviceWorker.getRegistrations();
        for (let registration of existingRegistrations) {
          await registration.unregister();
          log('ƒê√£ x√≥a service worker: ' + registration.scope);
        }

        // B∆Ø·ªöC 2: ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o cleanup ho√†n t·∫•t
        await new Promise(resolve => setTimeout(resolve, 1000));

        // B∆Ø·ªöC 3: ƒêƒÉng k√Ω service worker m·ªõi
        log('üìù ƒêƒÉng k√Ω Service Worker m·ªõi...');
        const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js', {
          updateViaCache: 'none' // Force update
        });
        log('Service Worker ƒëƒÉng k√Ω th√†nh c√¥ng: ' + registration.scope);

        // B∆Ø·ªöC 4: ƒê·ª£i service worker activate
        if (registration.installing) {
          log('‚è≥ ƒê·ª£i service worker installing...');
          await new Promise((resolve) => {
            registration.installing.addEventListener('statechange', (e) => {
              if (e.target.state === 'activated') {
                resolve();
              }
            });
          });
        }

        // B∆Ø·ªöC 5: ƒê·∫£m b·∫£o service worker ƒë√£ active
        await navigator.serviceWorker.ready;
        log('‚úÖ Service Worker ƒë√£ s·∫µn s√†ng v√† active');

        // B∆Ø·ªöC 6: Ki·ªÉm tra tr·∫°ng th√°i controller
        if (!navigator.serviceWorker.controller) {
          log('‚ö†Ô∏è Ch∆∞a c√≥ controller, reload page...');
          window.location.reload();
          return;
        }

        log('‚úÖ Service Worker controller: ' + navigator.serviceWorker.controller.scriptURL);

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
          log('Firebase app kh·ªüi t·∫°o th√†nh c√¥ng');
        }
        
        messaging = firebase.messaging();

        // Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o
        log('Y√™u c·∫ßu quy·ªÅn th√¥ng b√°o...');
        const permission = await Notification.requestPermission();
        log('Notification permission: ' + permission);
        
        if (permission !== 'granted') {
          throw new Error('Quy·ªÅn th√¥ng b√°o b·ªã t·ª´ ch·ªëi');
        }

        // L·∫•y FCM token
        log('L·∫•y FCM token...');
        const token = await messaging.getToken({
          vapidKey: VAPID_KEY,
          serviceWorkerRegistration: registration
        });

        if (token) {
          currentToken = token;
          document.getElementById('token-display').textContent = token;
          document.getElementById('token-section').style.display = 'block';
          document.getElementById('message-examples').style.display = 'block';
          
          updateStatus('‚úÖ FCM kh·ªüi t·∫°o th√†nh c√¥ng! B√¢y gi·ªù b·∫°n c√≥ th·ªÉ d√πng DevTools Push.', 'success');
          log('FCM Token nh·∫≠n ƒë∆∞·ª£c th√†nh c√¥ng');
          log('B·∫°n c√≥ th·ªÉ test b·∫±ng DevTools Push Messaging ngay b√¢y gi·ªù!');
        } else {
          throw new Error('Kh√¥ng th·ªÉ l·∫•y FCM token');
        }

        // Listen cho messages khi app ƒëang foreground
        messaging.onMessage((payload) => {
          log('üì± Message nh·∫≠n ƒë∆∞·ª£c (foreground): ' + JSON.stringify(payload, null, 2));
          
          // Hi·ªÉn th·ªã notification th·ªß c√¥ng cho foreground
          if (payload.notification) {
            new Notification(payload.notification.title, {
              body: payload.notification.body,
              icon: '/firebase-logo.png',
              data: {
                click_action: payload.notification.click_action || payload.data?.click_action
              }
            }).onclick = function() {
              window.open(this.data.click_action || 'https://google.com', '_blank');
              this.close();
            };
          }
        });

        // Token refresh listener
        // messaging.onTokenRefresh(() => {
        //   log('üîÑ Token ƒë√£ ƒë∆∞·ª£c refresh');
        //   messaging.getToken({ vapidKey: VAPID_KEY }).then((refreshedToken) => {
        //     log('New token: ' + refreshedToken);
        //     currentToken = refreshedToken;
        //     document.getElementById('token-display').textContent = refreshedToken;
        //   });
        // });

      } catch (error) {
        updateStatus('‚ùå L·ªói: ' + error.message, 'error');
        log('‚ùå Error: ' + error.message);
        console.error('FCM Error:', error);
      }
    }

    function copyToken() {
      if (currentToken) {
        navigator.clipboard.writeText(currentToken).then(() => {
          updateStatus('‚úÖ Token ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard!', 'success');
        }).catch(() => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = currentToken;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          updateStatus('‚úÖ Token ƒë√£ ƒë∆∞·ª£c copy!', 'success');
        });
      }
    }

    // Auto start when page loads
    window.addEventListener('load', () => {
      log('‚ú® Trang ƒë√£ t·∫£i xong. Click "Kh·ªüi t·∫°o FCM" ƒë·ªÉ b·∫Øt ƒë·∫ßu test!');
    });

    // Listen for service worker messages
    navigator.serviceWorker.addEventListener('message', event => {
      log('üì® Message t·ª´ Service Worker: ' + JSON.stringify(event.data));
    });
  </script>
</body>
</html>
